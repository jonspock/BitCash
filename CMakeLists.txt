CMAKE_MINIMUM_REQUIRED(VERSION 2.8)

IF(NOT CMAKE_BUILD_TYPE)
  SET(CMAKE_BUILD_TYPE "RELEASE")
ENDIF()

if(${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
  list(APPEND CMAKE_PREFIX_PATH /opt/local/opt/qt5)
endif()


#if(CMAKE_CXX_FLAGS_RELEASE MATCHES DNDEBUG)
  string(REPLACE "-DNDEBUG" "" CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE}")
  string(REPLACE "-DNDEBUG" "" CMAKE_C_FLAGS_RELEASE "${CMAKE_C_FLAGS_RELEASE}")
#endif()

if(CMAKE_CXX_FLAGS_RELWITHDEBINFO MATCHES DNDEBUG)
  string(REPLACE "-DNDEBUG" "" CMAKE_CXX_FLAGS_RELWITHDEBINFO "${CMAKE_CXX_FLAGS_RELEASE}")
  string(REPLACE "-DNDEBUG" "" CMAKE_C_FLAGS_RELWITHDEBINFO "${CMAKE_C_FLAGS_RELEASE}")
endif()

project(Bitcash)

set(OPENSSL_VER "1.0.2q")
set(BDB_VER "4.8.30")

#---------------------------------------------------------------------------------------------------------
# Code coverage
#---------------------------------------------------------------------------------------------------------
if (${CMAKE_CXX_COMPILER_ID} STREQUAL "Clang")
    set(CMAKE_XCODE_ATTRIBUTE_GCC_VERSION "com.apple.compilers.llvm.clang.1_0")
    # Setup Code Coverage for XCode when requested
    if ($ENV{COVERAGE})
        message(STATUS "********* Setting up Xcode compile for Code coverage **********")
        set(CMAKE_XCODE_ATTRIBUTE_GCC_INSTRUMENT_PROGRAM_FLOW_ARCS "YES")
        set(CMAKE_XCODE_ATTRIBUTE_GCC_GENERATE_TEST_COVERAGE_FILES "YES")
        # Works for Clang->
				#set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -coverage")
    endif()
endif()

set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11 ")


IF (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
	add_compile_options(-Wno-potentially-evaluated-expression -Wno-unused-const-variable -Wno-unused-function -Wno-deprecated-declarations -Wno-inaccessible-base -Wno-unused-local-typedefs -Wno-logical-op-parentheses -Wno-shift-negative-value -Wno-array-bounds -Wno-unused-function -Wno-missing-field-initializers)
	add_definitions("-DOS_MACOSX -DLEVELDB_PLATFORM_POSIX") ### -DENABLE_ZMQ")
	add_definitions("-DENABLE_WALLET")
else()
	add_definitions("-Wno-cpp -Wno-unused-function")
	set(ANL anl)
endif()

# Disable -DHAVE_BUILD_INFO for now to avoid compiler error
add_definitions("-DHAVE_CONFIG_H -DBOOST_SPIRIT_THREADSAFE -D__STDC_FORMAT_MACROS -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=2")

add_definitions("-Wall -Wextra -Wformat -Wformat-security -Wno-unused-parameter -Wstack-protector -fstack-protector-all -fPIC -fvisibility=hidden")

# run autogen.sh if missing header files from configure on Linux/Mac
if (EXISTS	"${CMAKE_CURRENT_SOURCE_DIR}/configure")
else()	
  execute_process(
	COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/autogen.sh
	WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
	)
endif()

# run configure if pivx_config.h doesn't exist, For Linux add "--with-incompatible-bdb"
if (EXISTS	"${CMAKE_CURRENT_SOURCE_DIR}/src/config/bitcash-config.h")
else()	
	IF (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
	  execute_process(
		COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/configure 
		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
		)
else()
	  execute_process(
		COMMAND ${CMAKE_CURRENT_SOURCE_DIR}/configure  --with-incompatible-bdb
		WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
		)
	endif()
endif()


SET(COMMON_A
	./src/protocol.cpp
	./src/pubkey.cpp
	./src/netbase.cpp
	./src/keystore.cpp
	./src/key.cpp
	./src/hash.cpp
	./src/core_write.cpp
	./src/core_read.cpp
	./src/compressor.cpp
	./src/coins.cpp
	./src/chainparams.cpp
	./src/base58.cpp
  ###	./src/amount.cpp
  ./src/fs.cpp
  ./src/nicknames.cpp
  ./src/nicknamedb.cpp
	)

SET(UTIL_A
	./src/utiltime.cpp
	./src/utilmoneystr.cpp
	./src/util.cpp
	./src/sync.cpp
	./src/uint256.cpp
  #	./src/arith_uint256.cpp
	./src/rpc/protocol.cpp
	./src/random.cpp
	./src/clientversion.cpp
	./src/chainparamsbase.cpp
	)




SET(SERVER_A
	./src/addrman.cpp
	./src/bloom.cpp
	./src/chain.cpp
	./src/checkpoints.cpp
	./src/init.cpp
	./src/links.cpp
	./src/linksdb.cpp
	./src/payments.cpp
	./src/paymentsdb.cpp
  ./src/ui_interface.cpp

	./src/merkleblock.cpp
	./src/miner.cpp
	./src/net.cpp
	./src/noui.cpp
	./src/pow.cpp
	./src/rest.cpp
	./src/rpc/blockchain.cpp
	./src/rpc/mining.cpp
	./src/rpc/client.cpp
	./src/rpc/rawtransaction.cpp
	./src/rpc/net.cpp
	./src/rpc/protocol.cpp
	./src/rpc/server.cpp
	./src/rpc/misc.cpp
	./src/rpc/util.cpp

  #// For QT
  ./src/interfaces/node.cpp
  ./src/interfaces/handler.cpp
  ./src/interfaces/wallet.cpp
  
	)


SET(CONSENSUS
	./src/utilstrencodings.cpp
	./src/pubkey.cpp
	./src/key_io.cpp
	./src/bech32.cpp
	./src/uint256.cpp
	./src/arith_uint256.cpp
	./src/hash.cpp
)	

SET(CONSENSUS_CRYPTO
	./src/crypto/hmac_sha512.cpp
	./src/crypto/hmac_sha256.cpp
	./src/crypto/ripemd160.cpp
	./src/crypto/sha256.cpp
	./src/crypto/sha1.cpp
	./src/crypto/sha512.cpp
	./src/crypto/sha256_sse4.cpp
  ./src/crypto/ctaes/ctaes.c
  ./src/crypto/chacha20.cpp
  ./src/crypto/aes.cpp
  ./src/cuckoo/miner.cpp
  ./src/cuckoo/mean_cuckoo.cpp
  ./src/cuckoo/mean_cuckoo_.cpp
  ./src/cuckoo/cuckoo.cpp
  ./src/crypto/blake2/blake2b-ref.c

  ./src/crypto/aes_helper.c
  ./src/crypto/blake.c
  ./src/crypto/bmw.c
  ./src/crypto/cubehash.c
  ./src/crypto/echo.c
  ./src/crypto/groestl.c
  ./src/crypto/jh.c
  ./src/crypto/keccak.c
  ./src/crypto/luffa.c
  ./src/crypto/sha256_sse4.cpp
  ./src/crypto/shavite.c
  ./src/crypto/simd.c
  ./src/crypto/skein.c
  ./src/crypto/sph_hamsi.c
  ./src/crypto/sph_hamsi_helper.c
  ./src/crypto/sph_sha2.c
  ./src/crypto/sph_sha512.c
  ./src/crypto/sph_shabal.c
  ./src/crypto/sph_whirlpool.c
  ./src/crypto/sph_fugue.c
)

SET(SOURCES
	./src/compat/strnlen.cpp
	./src/compat/glibcxx_sanity.cpp
	./src/compat/glibc_sanity.cpp
  #	./src/compat/glibc_compat.cpp
  
  ./src/consensus/merkle.cpp
	./src/consensus/tx_verify.cpp
  
  ./src/utiltime.cpp
  ./src/validation.cpp
  ./src/threadinterrupt.cpp
  ./src/net_processing.cpp
  ./src/addrdb.cpp
  ./src/chain.cpp
  ./src/netaddress.cpp
  ./src/protocol.cpp
  ./src/versionbits.cpp
  ./src/dbwrapper.cpp
  
  ./src/blockencodings.cpp
	./src/miner.cpp
	./src/primitives/block.cpp
	./src/primitives/transaction.cpp
	./src/script/script_error.cpp
	./src/script/interpreter.cpp
	./src/script/script.cpp
	./src/script/bitcashconsensus.cpp
	./src/script/sign.cpp
	./src/script/sigcache.cpp
	./src/script/standard.cpp
	./src/script/ismine.cpp
	./src/timedata.cpp
	./src/txdb.cpp
	./src/index/txindex.cpp
  ./src/rest.cpp
	./src/torcontrol.cpp
	./src/txmempool.cpp
	./src/wallet/feebumper.cpp
	./src/wallet/coinselection.cpp
	./src/wallet/fees.cpp
	./src/wallet/wallet.cpp
	./src/wallet/walletutil.cpp
	./src/wallet/db.cpp
	./src/wallet/init.cpp
	./src/wallet/crypter.cpp
	./src/wallet/walletdb.cpp
	./src/wallet/rpcdump.cpp
	./src/wallet/rpcwallet.cpp
  ./src/univalue/lib/univalue_get.cpp
  ./src/univalue/lib/univalue_read.cpp
  ./src/univalue/lib/univalue_write.cpp
  ./src/univalue/lib/univalue.cpp
  ./src/httprpc.cpp
  ./src/httpserver.cpp
  ./src/scheduler.cpp
  ./src/validationinterface.cpp
#  ./src/support/pagelocker.cpp
  ./src/support/lockedpool.cpp
  ./src/support/cleanse.cpp
  ./src/policy/rbf.cpp
  ./src/policy/fees.cpp
  ./src/policy/feerate.cpp
  ./src/policy/policy.cpp
  ./src/warnings.cpp
  ./src/logging.cpp

	)

SET(ZMQ_SOURCES
  ./src/zmq/zmqnotificationinterface.cpp
  ./src/zmq/zmqpublishnotifier.cpp
  ./src/zmq/zmqabstractnotifier.cpp
  )
  


IF (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
  set(OPENSSL_ROOT_DIR "/usr/local/Cellar/openssl/${OPENSSL_VER}/")
  set(BDB_ROOT_DIR "/usr/local/Cellar/berkeley-db@4/${BDB_VER}/")
endif()

find_package(OpenSSL)
if (OPENSSL_FOUND)
  message(STATUS "Found OpenSSL")
endif()  

find_package( Boost COMPONENTS system filesystem thread program_options chrono)
link_directories ( ${Boost_LIBRARY_DIRS} )

include_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}/src
  ${CMAKE_CURRENT_SOURCE_DIR}/src/config
  ${CMAKE_CURRENT_SOURCE_DIR}/src/obj
  ${Boost_INCLUDE_DIRS}
  ${OPENSSL_INCLUDE_DIR}
  ${BDB_ROOT_DIR}/include
  ${CMAKE_CURRENT_SOURCE_DIR}/src/leveldb/include
  ${CMAKE_CURRENT_SOURCE_DIR}/src/univalue/include
  ${CMAKE_CURRENT_SOURCE_DIR}/src/leveldb/helpers/memenv
  ${CMAKE_CURRENT_SOURCE_DIR}/src/secp256k1
  ${CMAKE_CURRENT_SOURCE_DIR}/src/secp256k1/include
  ${CMAKE_CURRENT_SOURCE_DIR}/src/qt/
  ${CMAKE_CURRENT_SOURCE_DIR}/src/qt/forms
  )

#file(GLOB_RECURSE HEADERS *.h)
file(GLOB HEADERS ${CMAKE_CURRENT_SOURCE_DIR}/src/*.h)

file(GLOB CRYPTO_HEADERS ${CMAKE_CURRENT_SOURCE_DIR}/src/crypto/*.h)
source_group("CryptoHeaders" FILES ${CRYPTO_HEADERS})

file(GLOB CONSENSUS_HEADERS ${CMAKE_CURRENT_SOURCE_DIR}/src/consensus/*.h)
source_group("ConsensusHeaders" FILES ${CONSENSUS_HEADERS})

file(GLOB PRIMITIVE_HEADERS ${CMAKE_CURRENT_SOURCE_DIR}/src/primitives/*.h)
source_group("PrimHeaders" FILES ${PRIMITIVE_HEADERS})

add_library(coin ${HEADERS} ${CRYPTO_HEADERS} ${CONSENSUS_HEADERS} ${PRIMITIVE_HEADERS} ${SOURCES} ${ZMQ_SOURCES} ${COMMON_A} ${UTIL_A} ${SERVER_A} ${CONSENSUS} ${CONSENSUS_CRYPTO})
set_property(TARGET coin PROPERTY CXX_STANDARD 11)

add_subdirectory(src)

#	add_definitions("-DUSE_FIELD_5X52")
#	add_definitions("-DUSE_FIELD_5X52_ASM")

set(SECP256
	./src/secp256k1/src/secp256k1.c
	)
add_library(secp256k1 ${SECP256})

link_directories(${BDB_ROOT_DIR}/lib)

add_executable(bitcash-cli ${CMAKE_CURRENT_SOURCE_DIR}/src/bitcash-cli.cpp)
add_executable(bitcash-tx ${CMAKE_CURRENT_SOURCE_DIR}/src/bitcash-tx.cpp)
add_executable(bitcashd ${CMAKE_CURRENT_SOURCE_DIR}/src/bitcashd.cpp)

target_link_libraries(bitcash-cli coin db_cxx db secp256k1 gmp leveldb ${OPENSSL_LIBRARIES} ${Boost_LIBRARIES} ${ANL} miniupnpc event event_pthreads pthread )
target_link_libraries(bitcash-tx coin secp256k1 coin leveldb ${OPENSSL_LIBRARIES} ${Boost_LIBRARIES} ${ANL} pthread)

IF (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
	target_link_libraries(bitcashd coin db_cxx db secp256k1 gmp leveldb ${OPENSSL_LIBRARIES} ${Boost_LIBRARIES} ${ANL} zmq miniupnpc event event_pthreads pthread )
else()
	target_link_libraries(bitcashd coin db_cxx db secp256k1 leveldb ${OPENSSL_LIBRARIES} ${Boost_LIBRARIES} ${ANL} pthread)
endif()

add_subdirectory(src/qt)

#---------------------------------------------------------------------------------------------------------
# Create a target in Xcode to setup coverage script
#---------------------------------------------------------------------------------------------------------
if ($ENV{COVERAGE})
    add_custom_target(xcov COMMAND ./XcodeCoverage/exportenv.sh )
endif()

#add_subdirectory(src/test)
  


